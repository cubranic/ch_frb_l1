<!doctype html>
<html>
<head>
<title>CHIME FRB L1 status</title>

<script type="text/javascript" src="{{ url_for('static', filename='jquery.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='d3.min.js') }}"></script>

<script type="text/javascript">
{% include "strip-chart.js" %}
</script>

</head>
<body>

<h3>L1 node {{node}}</h3>

<div id="packet-count-graph"></div>

<p>
<input type="button" onClick="stopUpdating()"  value="Stop updating" />
<input type="button" onClick="startUpdating()" value="Start updating"/>
</p>

<script type="text/javascript">

// Are we updating the plot?
var do_update = true;

// How many milliseconds between updates?
var update_period = 2000;

var chart = new StripChart(600, 300, '#packet-count-graph', 'Packet count',
                           60, update_period);
var chart_dates = [];
var chart_values = [];
var chart_max = 0;

// Handle the JSON data when we're updating the matrix.
function json_callback(X) {
    console.log('JSON callback: ' + X);
    if (!do_update) {
        return;
    }
    if (X == null) {
        setTimeout('json_update()', update_period);
        return;
    }

    pcounts = X['count_packets_received'];
    console.log('Packet counts: ' + pcounts);
    
    chart_dates.push(new Date());
    chart_values.push(pcounts);
    if (chart_dates.length > 60) {
        chart_dates.shift();
        chart_values.shift();
    }
    chart_max = Math.max(chart_max, pcounts);
    chart.ymin = 0;
    chart.ymax = chart_max;
    chart.update(chart_dates, chart_values);

    setTimeout('json_update()', update_period);
}

// Make a JSON request for the node status
function json_update() {
    d3.request('{{ node_status_json_url }}')
        .mimeType("application/json")
        .response(function(xhr) { return JSON.parse(xhr.responseText); })
        .get(json_callback);
}

// Fetch first data set!
json_update();

function startUpdating() {
    do_update = true;
    json_update();
}
function stopUpdating() {
    do_update = false;
}

</script>


</body>
</html>
