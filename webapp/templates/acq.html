<!doctype html>
<html>
<head>
<title>CHIME FRB L1 status</title>

<script type="text/javascript" src="{{ url_for('static', filename='jquery.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='d3.min.js') }}"></script>

<style>
table {
border-collapse: collapse;
}
th, td {
    padding: 5px;
    text-align: center;
}
</style>

</head>

<body>

<h3>Current L1 node acquisition status</h3>

<p>
<input type="button" onClick="stopUpdating()"  value="Stop updating" />
<input type="button" onClick="startUpdating()" value="Start updating"/>
<span id="json-status"> </span>
Last update: <span id="last-update">--</span>
</p>

<table border="1">
<tr><td>
Acquisition name: <input type="text" size="20" id="start_acq_name"><br />
Notes about this acquisition:<br />
<textarea cols="50" rows="5" id="start_acq_meta"></textarea>
    <br />
    <br />
<input type="button" value="Start Acquisition on all nodes"
 onClick="startAcq();" style="font-size:125%;">
</td></tr>
</table>

    <br />
    <br />
    
<table border="1">
  <tr>
    <th>Node</th><th>Current Acq Name</th><th>Size</th><th>Status</th>
  </tr>
  {% for i,node in enodes %}
  <tr>
    <td>{{node}}</td><td id="node_acq_{{i}}">---</td><td id="node_acqsize_{{i}}">---</td><td id="node_status_{{i}}">---</td>
  </tr>
{% endfor %}
</table>
  
<br><hr><br>

<script type="text/javascript">
// Are we updating the plot?
var do_update = true;

// How many milliseconds between updates?
var update_period = 10000;


function json_callback(X) {
    //console.log('JSON callback: ' + X);

    if (!do_update) {
        $('#json-status').html('Stopped.');
        return;
    }
    
    if (X == null) {
        $('#json-status').html('Empty reply');
        setTimeout('json_update()', update_period);
        return;
    }
    $('#last-update').html(new Date());
    $('#json-status').html('Got reply');

    //
    var status = X;
    for (var i=0; i<status.length; i++) {
        var st = status[i];
        if (st == null) {
            var sel = '#node_status_'+i;
            $(sel).html('Status query timed out');
            var sel = '#node_acq_'+i;
            $(sel).html('---');
            continue;
        }
        var fn = status[i]['stream_filename'];
        fn = fn.replace('beam_(BEAM)/chunk_(CHUNK).msg', '');
        var sel = '#node_acq_'+i;
        if (fn.length == 0) {
            fn = '(none)';
        }
        $(sel).html(fn);
    }

    
    setTimeout('json_update()', update_period);
}

// Make a JSON request for the packet matrix; call "json_callback"
function json_update() {
    $('#json-status').html('Sending...');
    d3.request('/acq-status-json')
        .mimeType("application/json")
        .response(function(xhr) { return JSON.parse(xhr.responseText); })
        .get(json_callback);
}

// Fetch first data set!
json_update();

function startUpdating() {
    do_update = true;
    json_update();
}
function stopUpdating() {
    do_update = false;
}

function startAcq() {
    meta = {};
    meta['notes'] = $('#start_acq_meta').val();
    jmeta = JSON.stringify(meta);
    console.log('JSON metadata:', jmeta);

    acqname = $('#start_acq_name').val();
    console.log('Acq name:', acqname);

    args = {};
    args['acqname'] = acqname;
    args['acqmeta'] = jmeta;
    jargs = JSON.stringify(args);
    
    d3.request('/acq-start')
        .mimeType("application/json")
    	.header('Content-Type', 'application/json')
        .response(function(xhr) { return JSON.parse(xhr.responseText); })
        .post(jargs, start_acq_callback);
}

function start_acq_callback(err, X) {
    for (var i=0; i<X.length; i++) {
        var ok = X[i][0];
        var sel = '#node_status_' + i;
        if (ok) {
            $(sel).html('Started');
        } else {
            $(sel).html(X[i][1]);
        }
    }
    json_update();
}

</script>

</body>
</html>
