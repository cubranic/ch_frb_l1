<!doctype html>
<html>
<head>
<title>CHIME FRB L1 status</title>

<script type="text/javascript" src="{{ url_for('static', filename='jquery.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='d3.min.js') }}"></script>

</head>

<body id="thebody">

<div id="ratematrix"></div>

<style>
</style>

<script type="text/javascript">

var do_update = true;

// var nodew = 3;
// var nodeh = 8;
// var top_margin = 20;
// var left_margin = 20;

var W = 600;
var H = 400;

var svg = d3.select("#ratematrix").append('svg')
    .attr('width', W)
    .attr('height', H);

var yscale = d3.scaleLinear().rangeRound([H, 0]);
var xscale = d3.scaleLinear().rangeRound([0, W]);

// Set the ranges
//var xscale = d3.scale.linear().range([0, W]);
//var yscale = d3.scale.linear().range([H, 0]);

// Define the axes
//var xaxis = svg.axis().scale(xscale)
//    .orient("bottom").ticks(5);
//
//var yaxis = svg.axis().scale(y)
//    .orient("left").ticks(5);
// svg.append("g")
//     .attr("class", "x axis")
//     .attr("transform", "translate(0," + H + ")")
//     .call(xaxis);
// svg.append("g")
//     .attr("class", "y axis")
//     .call(yaxis);

var line = d3.line()
    .x(function(d) { return xscale(d.t); })
    .y(function(d) { return yscale(d.r); });

svg.append('g')
    .attr('transform', 'translate(0,' + H + ')')
    .call(d3.axisBottom(xscale));

svg.append('g')
    .call(d3.axisLeft(yscale))
    .append('text')
    .attr('fill', '#000')
    .attr("transform", "rotate(-90)")
    .attr("y", 6)
    .attr("dy", "0.71em")
    .attr("text-anchor", "end")
    .text("Rate (packets/second)");

var nodes = [];

var path = svg.append("path")
    .attr("class", "line")
    .datum(nodes)
    .attr("fill", "none")
    .attr("stroke", "steelblue")
    .attr("stroke-linejoin", "round")
    .attr("stroke-linecap", "round")
    .attr("stroke-width", 1.5)
    .attr("d", line(nodes));

function array_max(A) {
    if (A.length == 0) { return 0; }
    return A.reduce(function(a, b) { return Math.max(a, b); }, A[0]);
}
function array_min(A) {
    if (A.length == 0) { return 0; }
    return A.reduce(function(a, b) { return Math.min(a, b); }, A[0]);
}

function json_callback(X) {
    console.log('JSON callback: ' + X);
    if (!do_update) {
        return;
    }
    if (X == null) {
        setTimeout('json_update()', 2000);
        return;
    }

    times = X['times'];
    rates = X['rates'];
    nreplies = X['nreplies'];
    ntotal = X['ntotal'];

    console.log('' + nreplies + ' of ' + ntotal);
    
    $('#replies').html('' + nreplies + ' of ' + ntotal);
    
    var rmax = array_max(rates);
    var rmin = array_min(rates);
    var tmax = array_max(times);
    var tmin = array_min(times);

    console.log('Time: ' + tmin + ' to ' + tmax);
    console.log('Rate: ' + rmin + ' to ' + rmax);

    for (var i=0; i<times.length; i++) {
        nodes.push({ t: times[i], r: rates[i] });
    }

    // Select the section we want to apply our changes to
    //var svg = d3.select("body").transition();

    svg.selectAll('path')
        .data(nodes);
    // svg.append('g').selectAll('rect')
    //     .data(nodes)
    //     .enter().append('rect')
    //     .attr('x', function(node){ return W * (node.t - tmin) / (tmax-tmin); })
    //     .attr('y', function(node){ return H * (node.r - rmin) / (rmax-rmin); })
    //     .attr('width', 10)
    //     .attr('height', 10)
    //     .style('fill', 'rgb(128,128,128)');

    xscale.domain(d3.extent(nodes, function(d) { return d.t; }));
    yscale.domain(d3.extent(nodes, function(d) { return d.r; }));

    // Make the changes
    svg.select(".line")   // change the line
        //.duration(250)
        .attr("d", line(nodes));
    // svg.select(".x.axis") // change the x axis
    //     //.duration(250)
    //     .call(xaxis);
    // svg.select(".y.axis") // change the y axis
    //     //.duration(250)
    //     .call(yaxis);
    

    
    /*
      for (i=0; i<packets.length; i++) {
      nodes[i].value = rates[i];
      }
      
      rgb_nodes.selectAll('rect').transition()
      .style('fill', function(node){return rgb(node.value, 0, pmax);});

      // jquery update rate low/high text
      $('#rate_low').html(pmin.toFixed(3));
      $('#rate_high').html(pmax.toFixed(3));
    */
    
    setTimeout('json_update()', 2000);
}

function json_update() {
    d3.request('/packet-rate-l0-json/{{ node0ip }}')
        .mimeType("application/json")
        .response(function(xhr) { return JSON.parse(xhr.responseText); })
        .get(json_callback);
}

json_update();

function startUpdating() {
    do_update = true;
    json_update();
}
function stopUpdating() {
    do_update = false;
}
</script>

<p>
Rate range: <span id="rate_low">low</span> to <span id="rate_high">high</span>
</p>
<p>
Number of L1 nodes responding: <span id="replies">---</span>
</p>
<p>
<input type="button" onClick="stopUpdating()"  value="Stop updating" />
<input type="button" onClick="startUpdating()" value="Start updating"/>
</p>

</body>
</html>
