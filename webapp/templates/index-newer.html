<!doctype html>
<html>
<head>
<title>CHIME FRB L1 status</title>

<script type="text/javascript" src="{{ url_for('static', filename='jquery.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='d3.min.js') }}"></script>

</head>

<body id="thebody">

<style>
.good {
background-color: lightsteelblue;
}
.bad {
background-color: pink;
}
.rotate {
writing-mode: vertical-lr;
}
</style>
<script type="text/javascript">
</script>

<h3>CHIME FRB Diagnostics</h3>

<ul>
<li><a href="{{ packet_matrix_url }}">Packet rate matrix (text)</a></li>
<li><a href="{{ packet_matrix_image_url }}">Packet rate matrix (image)</a></li>
<li><a href="{{ packet_matrix_d3_url }}">Packet rate matrix (d3)</a></li>
</ul>

<h3>CHIME FRB L1 node status</h3>

<table>
  <tr>
    <th>Nodes</th>
    {% for i,node in enodes %}
    <td><a href="node/{{node}}">{{ i+1 }}</a></td>
    {% endfor %}
  </tr>

{#
  <tr>
    <th>Up</th>
    {% for node in nodes %}
    <td
       {% if nodeup[node] == "0" %}
       class="bad"
       {% else %}
       class="good"
       {% endif %}
       >
      {{ nodeup[node] }}
      </td>
    {% endfor %}
  </tr>
#}
</table>

{#
<iframe src="http://localhost:3000/dashboard-solo/db/node-exporter-single-server?orgId=2&panelId=11&var-server=" width="450" height="200" frameborder="0"></iframe>
#}

<h3>CHIME FRB L1 Command and Control</h3>

<p>Run a command on all L1 nodes:</p>
<input type="text" id="cnc_run" size="50" value="echo hello world, I am $HOSTNAME, $(date), __INDEX__" />
<span id="cnc_status"></span><br />
<p id="cnc_output"></p>

<p>Launch a command on all L1 nodes:</p>
<input type="text" id="cnc_launch" size="50" value="./ch-frb-l1 -t l1_config/l1_production_16beam___INDEX__.yaml" />
<span id="cnc_launch_status"></span><br />
<p id="cnc_launch_output"></p>

<script type="text/javascript">

function cnc_callback(stat, output, err, X) {
    console.log('cnc_callback: err ' + err + ', result ' + X);
    $(stat).html('Received results.');
    ss = '<pre>';
    for (var i=0; i<X.length; i++) {
        xi = X[i];
        server = xi[0];
        res = xi[1];
        if (res == null) {
            rtn = 'null';
            out = '';
            err = '';
        } else {
            rtn = res[0];
            out = res[1];
            err = res[2];
        }
        ss += 'server ' + server + ': return value ' + rtn + '<br/>';
	if ((out != null) && (out.length))
	    ss += out + '<br/>';
	if ((err != null) && (err.length))
	    ss += '</pre><font color="red"><pre>' + err + '</pre></font><br/>';
        //ss += '<br/>out: ' + out;
        //ss += '<br/>err: ' + err;
        ss += '<br/>';
    }
    ss += '</pre>';
    $(output).html(ss);
}


$('#cnc_run').keyup(function(event) {
    if (event.keyCode == 13){
        $('#cnc_status').html('Sending command...');
	d3.request('{{ cnc_run_url }}')
            .header("Content-Type", "application/x-www-form-urlencoded")
            .mimeType("application/json")
            .response(function(xhr) { return JSON.parse(xhr.responseText); })
            .post("cmd=" + $('#cnc_run').val(), function(err,X){ cnc_callback('#cnc_status', '#cnc_output', err, X)});
    }
});

$('#cnc_launch').keyup(function(event) {
    if (event.keyCode == 13){
        $('#cnc_launch_status').html('Sending command...');
        d3.request('{{ cnc_run_url }}')
            .header("Content-Type", "application/x-www-form-urlencoded")
            .mimeType("application/json")
            .response(function(xhr) { return JSON.parse(xhr.responseText); })
            .post("cmd=" + $('#cnc_launch').val()+"&launch=yes",
		  function(err,X){ cnc_callback('#cnc_launch_status', '#cnc_launch_output', err, X)});
    }
});

</script>

<br><hr><br>


</body>
</html>
